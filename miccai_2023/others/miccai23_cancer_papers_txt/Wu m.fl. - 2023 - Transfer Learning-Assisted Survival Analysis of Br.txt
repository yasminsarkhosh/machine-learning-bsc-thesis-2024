Transfer Learning-Assisted Survival Analysis of Breast Cancer Relying on the Spatial Interaction Between Tumor-Inﬁltrating Lymphocytes and Tumors Yawen Wu1 , Yingli Zuo1,QiZhu1 , Jianpeng Sheng2 , Daoqiang Zhang1(B), and Wei Shao1(B) 1 College of Computer Science and Technology, Nanjing University of Aeronautics and Astronautics, MIIT Key Laboratory of Pattern Analysis and Machine Intelligence, Nanjing 211106, China {dqzhang,shaowei20022005}@nuaa.edu.cn 2 School of Medicine, Zhejiang University, Zhejiang 310058, China Abstract. Whole-Slide Histopathology Image (WSI) is regarded as the gold standard for survival prediction of Breast Cancer (BC) across different subtypes. However, in cancer prognosis applications, the cost of acquiring patients’ survival information is high and can be extremely diﬃcult in practice. By considering that there exists a certain common mechanism for tumor progression among diﬀerent subtypes of Breast Invasive Carcinoma(BRCA), it becomes critical to utilize data from a related subtype of BRCA to help predict the patients’ survival in the target domain. To address this issue, we proposed a TILs-Tumor interactions guided unsupervised domain adaptation (T2UDA) algorithm to predict the patients’ survival on the target BC subtype. Diﬀerent from the existing feature-level or instance-level transfer learning strategy, our study considered the fact that the tumor-inﬁltrating lymphocytes (TILs) and its correlation with tumors reveal similar role in the prognosis of diﬀerent BRCA subtypes. More speciﬁcally, T2UDA ﬁrst employed the Graph Attention Network (GAT) to learn the node embeddings and the spatial interactions between tumor and TILs patches in WSI. Then, besides aligning the embeddings of diﬀerent types of nodes across the source and target domains, we proposed a novel Tumor-TILs interaction alignment (TTIA) module to ensure that the distribution of interaction weights are similar in both domains. We evaluated the performance of our method on the BRCA cohort derived from the Cancer Genome Atlas (TCGA), and the experimental results indicated that T2UDA outperformed other domain adaption methods for predicting patients’ clinical outcomes. Y. Wu and Y. Zuo—Contribute equally to this work c The Author(s), under exclusive license to Springer Nature Switzerland AG 2023 H. Greenspan et al. (Eds.): MICCAI 2023, LNCS 14225, pp. 612–621, 2023. https://doi.org/10.1007/978-3-031-43987-2_59 Keywords: Tumor-inﬁltrating Lymphocytes · Unsupervised Domain Adaption · Prognosis Prediction · Graph Attention Network · Breast Cancer 1 Introduction Breast cancer (BC) is the most common cancer diagnosed among females and the second leading cause of cancer death among women after lung cancer [1]. The BC diﬀers greatly in clinical behavior, ranging from carcinoma in site to aggressive metastatic disease [2,3]. Thus, eﬀective and accurate prognosis of BC as well as stratifying cancer patients into diﬀerent subgroups for personalized cancer management has attracted more attention than ever before. Among diﬀerent types of imaging biomarkers, histopathological images are generally considered the golden standard for BC prognosis since they can confer important cell-level information that can reﬂect the aggressiveness of BC [4]. Recently, with the availability of digitalized whole-slide pathological images (WSIs), many computational models have been employed for the prognosis prediction of various subtypes of BC. For instance, Lu et al [5] presented a novel approach for predicting the prognosis of ER-Positive BC patients by quantifying nuclear shape and orientation from histopathological images. Liu et al [6] developed a gradient boosting algorithm to predict the disease progression for various subtypes of BC. However, due to the high-cost of collecting survival information from the patients, it is still a challenge to build eﬀective machine learning models for speciﬁc BC subtypes with limited annotation data. To deal with the above challenges, several researchers began to design domain adaption algorithms, which utilize the labeled data from a related cancer subtype to help predict the patients’ survival in the target domain. Speciﬁcally, Alirezazadeh et al [7] presented a new representation learning-based unsupervised domain adaption method to predict the clinical outcome of cancer patients on the target domain. Zhang et al [8] proposed a collaborative unsupervised domain adaptation algorithm, which conducts transferability-aware adaptation and conquers label noise in a collaborative way. Other studies include Xu et al [9] developed graph neural networks for unsupervised domain adaptation in histopathological image analysis, based on a backbone for embedding input images into a feature space, and a graph neural layer for propagating the supervision signals of images with labels. Although much progress has been achieved, most of the existing studies applied the feature alignment strategy to reduce the distribution diﬀerence between source and target domains. However, such transfer learning methods neglected to take the interaction among diﬀerent types of tissues into consideration. For example, it is widely recognized that tumor-inﬁltrating lymphocytes (TILs) and its correlation with tumors reveal a similar role in the prognosis of diﬀerent BRCA subtypes. For instance, Kurozumi et al [10] revealed that high TILs expression was correlated with negative estrogen receptor (ER) expression and high histological grade (P<0.001). Lu et al [11] utilized the TILs spatial pattern for survival analysis in diﬀerent breast cancer subtypes including ER-negative, ER-positive, and triple-negative. It can be expected that better prognosis performance can be achieved if we leveraged the TILs-Tumor interaction information to resolve the survival analysis task on the target domain. Based on the above considerations, in this paper, we proposed a TILs-Tumor interactions guided unsupervised domain adaptation (T2UDA) algorithm to predict the patients’ survival on the target BC subtype. Speciﬁcally, T2UDA ﬁrst applied the graph attention network (GATs) to learn node embeddings and the spatial interactions between tumor and TILs patches in WSI. In order to pre-serve the node-level and interaction-level similarities across diﬀerent domains, we not only aligned the embedding for diﬀerent types of nodes but also designed a novel Tumor-TILs interaction alignment (TTIA) module to ensure that the distribution of the interaction weights are similar in both domains. We evaluated the performance of our method on the Breast Invasive Carcinoma (BRCA) cohort derived from the Cancer Genome Atlas (TCGA), and the experimental results indicated that T2UDA outperforms other domain adaption methods for predicting patients’ clinical outcomes. 2Method We summarized the proposed T2UDA network in Fig. 1, which consists of three parts, i.e., Graph Attention Network-based Framework, Feature Alignment(FA), and TILs-Tumor interaction alignment(TTIA). Next, we will introduce each part in detail. Source GraphSource Sample Construction FA FA TTIA Target Graph Target Sample Construction TILs Patch Tumor Patch FA: Feature Alignment COX TTIA: Tumor-TILs Interaction Alignment Fig. 1. The overall framework of the T2UDA network. T2UDA aligns TILs-Tumor edge interaction weights in the TTIA module and feature vectors in the FA module to reduce the discrepancy between diﬀerent domains and achieving prognosis task on target BC patients. ℒ COXSAGPoolGAT SAGPoolGAT SAGPoolGAT SAGPoolGAT SAGPool GAT SAGPoolGAT Data Pre-processing. We obtained valid patches of 512 ×512 pixels from pathological images and segment the TILs and tumor tissues using a pre-trained U-Net++ model. Then we calculated the tumor and TILs area ratios in each patch and selected 300 patches with the largest ratios of each tissue type. Based on the selected patches, we constructed a graph G =(V,E)for each WSI. Here, given patches as nodes V, we ﬁrst calculated the pairwise distance among diﬀerent nodes, and select the top 10 percent connections with the smallest distance values as edges E. For each node in V, we followed the study in [12], which applied the ResNet-101 model to extract node features. Then, the principal component analysis (PCA) is implemented to reduce dimensionalities of the node features to 128. Calculating TILs-Tumor Interaction via Graph Attention Networks(GATs). To characterize the interaction between diﬀerent TILs and tumor patches, we employed GAT [13], which has been proven to be useful in describing the spatial interaction between diﬀerent tissues across WSIs. Our GAT-based framework consisted of 3 GAT layers interleaved with 3 graph pooling layers [14](shown in Fig. 1). The input of the GAT layer are H =[HL,HT ] ∈ Rd×600 , Hw =[hw 1 ,hw 2 ,...,hw ] ∈Rd×300,w ∈{L,T}represent the output fea300 tures for TILs and tumor nodes after PCA. The GAT layer generate a new group of node features H&#3; =[(HL)&#3; ,(HT )] via a weight matrix W ∈ Rd×d&#2; and (Hw)&#3; ∈Rd&#2;×300,w ∈{L,T}. Next, with a shared attentional mechanism Rd&#2; ×Rd&#2; →R, we calculated the attention coeﬃcients among diﬀerent nodes, which can be formulated as: eij = a([WhiWhj]) ,j ∈Ni. (1) Furthermore, a softmax function was then adopted to normalize the attention coeﬃcients eij : exp (eij )αij = softmaxj (eij )= &#2; , (2) k∈Ni exp (eik) where Ni represents all neighbors of node i. The new feature vector vi for node i was calculated via a weighted sum: vi = σαijWhj . (3) vj ∈N(vi) Finally, the output features of each GAT layer were aggregated in the readout layer. We fed the generated output features from each readout layer into the Cox hazard proportional regression model for the ﬁnal prognosis predictions. Feature Alignment. In the proposed GAT-based transfer learning framework, the feature alignment component was employed on its ﬁrst two layers. Then, for the node embeddings with diﬀerent types (TILs and Tumor) in both the source and target domain, we performed a mean pooling operation to obtain their aggregated features. Next, we aligned the aggregated tumor or TILs features from the two domains separately using Maximum Mean Discrepancy(MMD) [15]. Here, we adopted MMD for feature alignment due to its ability to measure the distance between two distributions without explicit assumptions on the data distribution, we showed the objective function of MMD in our method as follows: 2 &#6; nm &#4; &#6; 1 &#4; 1 &#7; rLFA = &#6; (fi,k)r − &#6; (4)f&#3; i,k nm r=1,2 k∈L,T i=1 i=1 H where H is a Hilbert space, f represents the features from the source, f&#3; represents the feature from the target, r represents the layer number, k ∈{L,T}referred to TILs or tumor node. In addition, n denotes the number of source samples, while m refers to the number of target samples. Fig. 2. The illustration of the proposed Interaction Weight Alignment module. TILs-Tumor Interaction Alignment. To accurately characterize the interaction between TILs and tumors, we further analyzed the extracted interaction weights by dividing them into 10 intervals (i.e., bins). For each interval, swe calculated the sum of all source domain interaction weights as i and the k sum of all target domain interaction weights as itk, where k represents the k-th interval. Consequently, we obtained two vectors and applied softmax on each ss sof them for normalization that can be denoted as pi =[i1,i2,··· ,i ]and 10 tqi =[i1,it 2,··· ,it ]. In order to measure the dissimilarity between pi and qi,10 the Kullback-Leibler (KL) divergence is adapted on the third layer of GAT, which can be formulated as: LTTIA = KL(pi,qi)= pi log (pi/qi) . (5) According to Eq.(5), we can ensure that the weight distributions for the TIL-Tumor interaction are consistent in the source and target domain, which will beneﬁt the following survival analysis. It is beneﬁcial for the target domain. Prognosis Prediction by the Cox Proportional Hazard Model. The Cox proportional hazard model was applied to predict the patients’ clinical outcome [16], and its negative log partial likelihood function can be formulated as: ⎛⎞N &#4; lprognosis = δi ⎝θT xi − log exp θT xj ⎠ (6) i=1 j∈R(ti) where xi represents the output of the last layer for the prognosis task and R (ti) is the risk set at time ti, which represents the set of patients that are still under risk before time t. In addition, δi is an indicator variable. Sample i refers to censored patient if δi = 0, otherwise δi =1. Overall Objective. To achieve domain-adaptive prognosis prediction, the ﬁnal loss function included the Cox loss, FA loss, and TTIA loss as the following formula: Lt = Lcox + αLFA + βLTTIA, (7) where α and β represent the weights assigned to the importance of FA component and TTIA component respectively. 3 Experiments and Results Datasets. We conducted our experiments on the breast invasive carcinoma (BRCA) dataset from The Cancer Genome Atlas (TCGA). Speciﬁcally, the BRCA dataset includes 661 patients with hematoxylin and eosin (HE)-stained pathological imaging and corresponding survival information. Among the collected BRCA patients in TCGA, the number of ER positive(ER+) and ER negative(ER−) patients are 515 and 146, respectively. We hope to investigate if the proposed T2UDA could be used to help improve the prognosis performance of (ER+) or (ER−) with the aid of the survival information on its counterpart. 3.1 Implementation Details and Evaluation Metrics The dimension of intermediate layers in GAT was 256. The pooling ratio in SagPool was set to 0.7. α and β were tuned from {0.01, 0.1}. During training, the model was trained for 150 epochs for both the main experiment and all comparative experiments. We used the Adam optimizer with a learning rate tuned from {1e − 5, 1e − 4}. We evaluated the performance of our model using the Concordance Index (CI) and Area Under the Curve (AUC) as performance metrics. Both CI and AUC range from 0 to 1, with larger values indicating better prediction performance and vice versa [1]. Table 1. Quantitative Performance Comparison between Diﬀerent Unsupervised Domain Adaptation Methods and Our Method. Fig. 3. The survival curves by applying diﬀerent methods on two benchmark settings: (1) source domain is ER+ BC and Target domain is ER− BC in (a); (2) source domain is ER− BC and Target domain is ER+ BC in (b). 3.2 Result and Discussion In this study, we compared the performance of our proposed model with several existing domain adaptation methods, including 1) DDC [17]: Utilize the Maximum Mean Discrepancy (MMD) to calculate the domain diﬀerence loss between source and target data and optimize both classiﬁcation loss and disparity loss. 2) DANN [18]: An adversarial learning method that used gradient backpropagation to extract domain-independent features. 3) MDD [19]: An adversarial training method that combined metric learning and domain adaptation. 4) DeepJDOT [20]: An Unsupervised Domain Adaptation method based on optimal transport that simultaneously learns features and optimizes classiﬁers by measuring joint feature/label diﬀerences. 5) Source only: it was trained on Proportion of Edges Connected TILs and Tumor Patches 60 50 40 Patient A, 84 months Patient B, 13 months 30 20 10 0 Patient C, 73 months Patient D, 19 monthsLow-risk group High-risk group source target TILs Patch Tumor Patch（a） (b) Fig. 4. (a): Compare proportion of Edges Connected TILs and Tumor patches of source and target domain (b): Compare interactions between TILs patches and tumor patches for long survival patients and short survival patients of source and target domain. The thick black line indicates the edges with higher weight. the source domain and applied directly to the target domain. 6) T2UDA-v1: it was a variant of T2UDA which didn’t use TTIA. The experimental results were presented in Table 1. The results presented in Table 1 revealed several key observations. First, our proposed method outperformed feature alignment-based methods such as DDC and DeepJDOT in terms of both CI and AUC values. The reason lies in that these methods only transferred the knowledge at the feature level and neglected the inter-relationship between TILs and tumors. Second, our method outperformed adversarial-based methods such as DANN and MDD, as the high heterogeneity between the target and source domains results in negative transfer through adversarial training. Instead of directly aligning regions, our proposed method focused on similar TILs-Tumor interactions and aligning patches of the same tissue. We also evaluated the contributions of the key components of our framework and found that T2UDA performed better than Source only and T2UDA-v1, which shows the advantage of minimizing diﬀerences in TILs-Tumor interaction weights. In addition, we also evaluated the patient stratiﬁcation performance of different methods. As shown in Fig. 3, our proposed T2UDA outperformed feature alignment-based methods (such as DDC and DeepJDOT), adversarial-based methods (such as DANN and MDD), and T2UDA-v1 in stratiﬁcation performance, proving that considering the interaction between TILs and tumors as migration knowledge leads to better prognostic results. We also examined the consistency of important edges in each group of stratiﬁed patients based on the TILs-Tumor interaction weights calculated by the Source Domain Target Domain GAT-based framework in the source and target domains. As seen in Fig. 4(a), for both the source and target domains, the proportion of edges that connect TILs and tumor regions in the low-risk group was higher than that in the highrisk group, showing that the interaction between TILs and tumors played a critical role in prognostic prediction in diﬀerent BC subtypes. Furthermore, as showninFig. 4(b), the weights of the edges connecting tumor and TILs regions were higher for patients in the low survival risk group in both source and target domains. This was consistent with our knowledge that brisk interaction between TILs and tumor regions indicates a better clinical outcome and demonstrates the transferability of this knowledge. Conclusion In this paper, we presented an unsupervised domain adaptation algorithm that leverages TILs-Tumor interactions to predict patients’ survival in a target BC subtype(T2UDA). Our results demonstrated that the relationship between TILs and tumors is transferable and can be eﬀectively used to improve the accuracy of survival prediction models. To the best of our knowledge, T2UDA was the ﬁrst method to successfully achieve interrelationship transfer between TILs and tumors across diﬀerent cancer subtypes for prognosis tasks. Acknowledgements. This work was supported by the National Natural Science Foundation of China (Nos.62136004, 61902183, 61876082, 61732006, 620761 29), the National Key R&D Program of China (Grant Nos.2018YFC2001600, 2018YFC2001602). References 1. Shao, W., Wang, T., Huang, Z., Han, Z., Zhang, J., Huang, K.: Weakly supervised deep ordinal cox model for survival prediction from whole-slide pathological images. IEEE Trans. Med. Imaging 40(12), 3739–3747 (2021) 2. Okabe, M., et al.: Predictive factors of the tumor immunological microenvironment for long-term follow-up in early stage breast cancer. Cancer Sci. 108(1), 81–90 (2017) 3. Mizukami, Y., et al.: Detection of novel cancer-testis antigen-speciﬁc t-cell responses in til, regional lymph nodes, and pbl in patients with esophageal squamous cell carcinoma. Cancer Sci. 99(7), 1448–1454 (2008) 4. Yawen, W., et al.: Recent advances of deep learning for computational histopathology: principles and applications. Cancers 14(5), 1199 (2022) 5. Cheng, L., et al.: Nuclear shape and orientation features from h&e images predict survival in early-stage estrogen receptor-positive breast cancers. Lab. Invest. 98(11), 1438–1448 (2018) 6. Liu, P., Fu, B., Yang, S.X., Deng, L., Zhong, X., Zheng, H.: Optimizing survival analysis of xgboost for ties to predict disease progression of breast cancer. IEEE Trans. Biomedical Eng. 68(1), 148–160 (2020) 7. Alirezazadeh, P., Hejrati, B., Monsef-Esfahani, A., Fathi, A.: Representation learning-based unsupervised domain adaptation for classiﬁcation of breast cancer histopathology images. Biocybern. Biomed. Eng. 38(3), 671–683 (2018) 8. Zhang, Y., et al.: Collaborative unsupervised domain adaptation for medical image diagnosis. IEEE Trans. Image Process. 29, 7834–7844 (2020) 9. Xu, D., Cai, C., Fang, C., Kong, B., Zhu, J., Li, Z.: Graph neural networks for unsuperviseddomain adaptation of histopathological imageanalytics. arXiv preprint arXiv:2008.09304 (2020) 10. Kurozumi, S., et al.: Prognostic signiﬁcance of tumour-inﬁltrating lymphocytes for oestrogen receptor-negative breast cancer without lymph node metastasis. Oncol. Lett. 17(3), 2647–2656 (2019) 11. Zixiao, L., et al.: Deep-learning-based characterization of tumor-inﬁltrating lymphocytes in breast cancers from histopathology images and multiomics data. JCO Clin. Cancer Informat. 4, 480–490 (2020) 12. Zuo, Y.: Identify consistent imaging genomic biomarkers for characterizing the survival-associated interactions between tumor-inﬁltrating lymphocytes and tumors. In: Medical Image Computing and Computer Assisted Intervention-MICCAI 2022: 25th International Conference, Singapore, 18–22 September 2022, Proceedings, Part II, pp. 222–231. Springer (2022). https://doi.org/10.1007/9783-031-16434-7 22 13. Veliˇckovi´c, P., Cucurull, G., Casanova, A., Romero, A., Lio, P., Bengio, Y.: Graph attention networks. arXiv preprint arXiv:1710.10903 (2017) 14. Lee, J., Lee, I., Kang, J.: Self-attention graph pooling. In: International Conference on Machine Learning, pp. 3734–3743. PMLR (2019) 15. Borgwardt, K.M., Gretton, A., Rasch, M.J., Kriegel, H.-P., Sch¨olkopf, B., Smola, A.J.: Integrating structured biological data by kernel maximum mean discrepancy. Bioinformatics 22(14), e49–e57 (2006) 16. Shao, W., et al.: Integrative analysis of pathological images and multi-dimensional genomic data for early-stage cancer prognosis. IEEE Trans. Med. Imaging 39(1), 99–110 (2019) 17. Tzeng, E., Hoﬀman, J., Zhang, N., Saenko, K., Darrell, T.: Deep domain confusion: Maximizing for domain invariance. arXiv preprint arXiv:1412.3474 (2014) 18. Ganin, Y., Ustinova, E., Ajakan, H., Germain, P., Larochelle, H., Laviolette, F., Marchand, M., Lempitsky, V.: Domain-adversarial training of neural networks. J. Mach. Learn. Res. 17(1), 2030–2096 (2016) 19. Zhang, Y., Liu, T., Long, M., Jordan, M.: Bridging theory and algorithm for domain adaptation. In: International Conference on Machine Learning, pp. 7404– 7413. PMLR (2019) 20. Damodaran, B.B., Kellenberger, B., Flamary, R., Tuia, D., Courty, N.: DeepJDOT: deep joint distribution optimal transport for unsupervised domain adaptation. In: Ferrari, V., Hebert, M., Sminchisescu, C., Weiss, Y. (eds.) ECCV 2018. LNCS, vol. 11208, pp. 467–483. Springer, Cham (2018). https://doi.org/10.1007/978-3030-01225-0 28 